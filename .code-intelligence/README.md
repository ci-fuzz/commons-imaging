# Fuzzing the Apache Commons Imaging Java Image Library

## What is Zint?

Apache Commons Imaging, previously known as Apache Commons Sanselan, is a library 
that reads and writes a variety of image formats, including fast parsing of 
image info (size, color space, ICC profile, etc.) and metadata. 

## What is fuzzing (in a nutshell)?

Fuzzing is a dynamic code analysis technique that supplies pseudo-random inputs
to a software-under-test (SUT), derives new inputs from the behaviour of the
program (i.e. how inputs are processed), and monitors the SUT for bugs.

Even though Commons Imaging is written in Java, which has the advantage
to be memory safe compared to C/C++, other potentially harmful bugs like uncaught
exceptions or denial of service problems can be detected using fuzzing.

## Fuzzing where raw data is handled

Fuzzing is most efficient where raw data is parsed, because in this case no
assumptions can be made about the format of the input. Commons Imaging allows you to process
arbitrary data using a collection of parsers for different image formats including jpeg, pgn, bnp and gif.


The most universal example of this type of fuzz test can be found in
[`.code-intelligence/fuzz_targets/JpegImageParserFuzzer.java`](https://github.com/ci-fuzz/commons-imaging/blob/master/.code-intelligence/fuzz_targets/JpegImageParserFuzzer.java).
Let me walk you through the heart of the fuzz test:

```Java
public class JpegImageParserFuzzer {
// 1. The function fuzzerTestOneInput will be repeatedly executed using data generated by the fuzzer as input
	public static void fuzzerTestOneInput(byte[] input) {	
		try {
// 2. Create an JpegImageParser and try to convert the input data into an image by calling the getBufferedImage function
			JpegImageParser p = new JpegImageParser();
			BufferedImage image = p.getBufferedImage(new ByteSourceArray(input), new HashMap<>());
// 3. Catch exceptions that are thrown when the image parser gets malformed input data. This behaviour 
is expected and we don't want to consider this a bug
		} catch (IOException | ImageReadException e) {
			return;
		}
	}
}
```

If you haven't done already, you can now explore what the fuzzer found when
running this fuzz test.

## A note regarding corpus data (and why there are more fuzz tests to explore)

For each fuzz test that we write, a corpus of interesting inputs is built up.
Over time, the fuzzer will add more and more inputs to this corpus, based
coverage metrics such as newly-covered lines, statements or even values in an
expression.

The rule of thumb for a good fuzz test is that the format of the inputs should
be roughly the same. Therefore, it is sensible to split up the big fuzz test for
all barcode types into individual fuzz tests.
